<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Tibetan-English Dictionary</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no" />

  <link rel="stylesheet" href="lib/jquery_tooltip/tooltip.css">

  <script src="settings/globalsettings.js"></script>
  <script src="lib/jquery/jquery.js"></script>
  <script src="lib/datatables/media/js/jquery.dataTables.min.js"></script>
  <script src="lib/jquery_bbq/jquery.ba-hashchange.min.js"></script>
  <script src="lib/jquery_textchange/jquery.textchange.js"></script>
  <script src="lib/tokenizer/tokenizer-1.0.1.js"></script>
  <script src="lib/jquery_tooltip/tooltip.js"></script>
  <script src="data/syllablelist.js"></script>
  <script src="settings/dictlist.js"></script>
  <script src="settings/abbreviations.js"></script>
  <script src="cordova.js"></script>
  <!--<script src="SQLitePlugin.js"></script>-->
  
  <script>
  
    var PhpDataAccess={
      readTerm:function(term, lang, dictionaries, saveState) {
        $.ajax({
          type: 'POST',
          url: "dict.php",
          dataType: 'json',
          data: {
            term:term,
            lang:lang,
            dictionaries:dictionaries
          },
          cache: true,
        }).done(function(data) { 
          DICT.loadTerm(term, data, saveState);
        }).fail(function(xhr,msg,err) {
          alert(msg + '\n' + err);
        });
      },
      
      readTermList:function(inputText, lang, offset, maxResults, dictionaries, callback){
        $.ajax({
          type: 'POST',
          url: 'dict.php',
          dataType: 'json',
          data: {
            search:inputText,
            lang:lang,
            offset:offset,
            maxresults:maxResults,
            dictionaries:dictionaries
          },
          cache: true,
        }).done(function(data) { 
          callback( data );
        }).fail(function(xhr,msg,err) {
          alert(msg + '\n' + err);
        });
      },
      
      checkTibetanSectionsForLinks:function( sections ) {
        var availableSections={};
        $.ajax({
          type: 'POST',
          url: 'dict.php',
          dataType: 'json',
          data: {
            checkTerms:sections
          },
          cache: true,
        }).done(function(data) {
          DICT.activateInlineTibetanSections(data);
        }).fail(function(xhr,msg,err) {
          alert(msg + '\n' + err);
        });
      },
      
      initDB:function(callback) {
        callback(); // no need to initialize the DB if the PHP backend on the server is used for data accesss. The app is ready right away
      },
    };

    var CordovaDataAccess={
      DB_NAME:"TibetanDictionary",
      db:null,
      
      _openDB:function() {
        try{
          if(!this.db) {
            var db = window.sqlitePlugin.openDatabase({  
                name:this.DB_NAME,
                location:'default',
                androidDatabaseImplementation:2 // use built-in Database class of Android rather than alternative plugin with native lib
            }, function(db) { //success
                // do nothing
            }, function(msg) { // error
                cordova.exec(function(msg){ 
                  var errorMsg = "<h1>Sorry, there was an error while initializing the database - the app is unable to continue :-(</h1><p>The app could not copy the dictionary database onto your device and is therefore unable to function. Check if you have enough internal memory available on your device (100MB or more). Please send the following information to the following email address: dictionary@christian-steinert.de</p><p>THANK YOU!</p><p>&nbsp;</p><h1>Error log:</h1><ul style=\"text-align:left\"><li>" + msg.replace(/\n/g,"</li><li>") + "</li></ul>";
                  $('#init').html(errorMsg);
                }, function(){}, "SQLitePlugin", "getLog", []);
               
            });
            
            this.db = db;
          }
          return this.db;
        } catch(e) {
          alert('error while opening DB:'+e.message);
        }
      },

      /** build an SQL WHERE-clause for an array of values */
      _mergeOrClauses:function(paramName, paramValues) {
          var clauses=[];
          $.each(paramValues,function(index,value){
            var sqlEscape = value.replace(/"/g, '""' ).replace(/\\/g,'\\\\');
            clauses.push( paramName+'="' + sqlEscape + '"' );
          });
          return '('+clauses.join(' OR ')+')';
      },
      
      readTerm:function(term, lang, dictionaries, saveState) {
        var db = this._openDB();
        db.transaction(function(tx) {
          try{
            var tab = CordovaDataAccess.getTabName(lang);
            var tabLang = "";
            if(lang=="en")
                tabLang = "en";
            else 
                tabLang = "bo";
            
            tx.executeSql('SELECT '+tab+'.term as term, '+tab+'.definition as definition, DICTNAMES.name as dictionary FROM '+tab+' inner join DICTNAMES on '+tab+'.dictionary = DICTNAMES.id and DICTNAMES.language = "'+tabLang+'" WHERE term=?', [term], function(tx, results) {
              var len=results.rows.length;
              var definitions={};
              for(var i=0; i<len; i++) {
                var row = results.rows.item(i);
                
                if(definitions[row.dictionary]) {
                  definitions[row.dictionary]+='\\n'+row.definition;
                } else {
                  definitions[row.dictionary]=row.definition;
                }
              }
              try {
//                db.close();
              } catch (ex) {}

              DICT.loadTerm(term,definitions,saveState);

            }, function(tx, error){
              alert('SQL error while reading term "'+term+'" from DB:'+error.message);
              try {
//                db.close();
              } catch (ex) {}
            });
          } catch(e) {
            alert('error while reading term "'+term+'" from DB:'+e.message);
          }
        });
      },

      checkTibetanSectionsForLinks:function(sections){
        setTimeout( function(){
          var wylieSections=[];
          $.each(sections, function(sectionId, sectionInfo){
            wylieSections.push(sectionInfo.wylie);
          });
          var termQuery = CordovaDataAccess._mergeOrClauses('term', wylieSections);
          var db = CordovaDataAccess._openDB();
          db.transaction(function(tx) {
            try{
              tx.executeSql('SELECT DISTINCT term FROM DICT WHERE ' + termQuery, [], function(tx, results) {
                var availableSections={};
                var len=results.rows.length;
                for(var i=0; i<len; i++) {
                  var row = results.rows.item(i);
                  $.each(sections,function(sectionId,sectionInfo){
                    if(sectionInfo.wylie === row.term) {
                      availableSections[sectionId] = sectionInfo;
                    }
                  });
                }
                try {
//                    db.close();
                } catch (ex) {}
                DICT.activateInlineTibetanSections(availableSections);
              }, function(tx, error) {
                alert('SQL error while checking existence of terms:'+error.message);
                try {
//                  db.close();
                } catch (ex) {}
              });
            } catch(e) {
              alert('error while checking existence of terms:'+e.message);
            }
          });
        }, 10 );
      },

      initDB:function(callback) {
        setTimeout(function() {
          // open the db to make sure that it is available by selecting one record from it.
          var db = CordovaDataAccess._openDB();
          db.transaction(function(tx) {
            try{
              tx.executeSql('SELECT * FROM DICT WHERE term="chos" LIMIT 1', [], function(tx, results) {
                if(results.rows.length) {
                  try {
//                    db.close();
                  } catch (ex) {}
                  callback();
                }
              }, function(tx, error){
                alert('SQL error while trying to read from the database:'+error.message);
                try {
//                    db.close();
                } catch (ex) {}
              });
            } catch(e) {
              alert('error while trying to read from the database:'+e.message);
            }
          });
        },100);
      },
      
      getTabName:function(lang) {
        if (lang === 'en' )
            return 'DICT_EN';
        else 
            return 'DICT';      
      },
      
      readTermList:function(term, lang, offset, maxResults, dictionaries, callback) {
        var db = this._openDB();
        var term = term.replace(/\s*[/]\s*$/,'');
        
        db.transaction(function(tx) {
          try{          
            var dictQuery = CordovaDataAccess._mergeOrClauses('DICTNAMES.name',dictionaries);
            var tab = CordovaDataAccess.getTabName(lang);
            
            if(term.indexOf("*") >= 0) { // wildcard search
              var likeSearch = term.replace(/[*]/g,'%') + '%';

              if ( lang === "tib" )
                var langId = "bo";
              else 
                var langId = "en";
            
              query = 'SELECT DISTINCT '+tab+'.term as term FROM '+tab+' inner join DICTNAMES on '+tab+'.dictionary = DICTNAMES.id and DICTNAMES.language = "'+langId+'" WHERE ( ( term LIKE ? ) AND ( '+dictQuery+' ) ) GROUP BY term ORDER BY lower(term), term LIMIT '+ maxResults +' OFFSET ' + offset;
              
              queryParams = [likeSearch];
            
            } else if ( lang === "tib" ) { // regular Tibetan search
              var termSearch1 = term + ' ';
              var termSearch2 = term + ' zzzzz';

              query = 'SELECT DISTINCT '+tab+'.term as term FROM '+tab+' inner join DICTNAMES on '+tab+'.dictionary = DICTNAMES.id and DICTNAMES.language = "bo" WHERE ( (( term = ? ) OR ( term > ? AND term < ? )) AND '+dictQuery+' ) GROUP BY term ORDER BY lower(term), term LIMIT '+ maxResults +' OFFSET ' + offset;
              queryParams = [term,termSearch1,termSearch2];
            } else { // regular English search
              var termSearch1 = term;
              var termSearch2 = term + 'zzzzz';

              query = 'SELECT DISTINCT '+tab+'.term as term FROM '+tab+' inner join DICTNAMES on '+tab+'.dictionary = DICTNAMES.id and DICTNAMES.language = "en" WHERE ( (( term = ? COLLATE NOCASE ) OR ( term > ? COLLATE NOCASE AND term < ?  COLLATE NOCASE )) AND '+dictQuery+' ) GROUP BY term ORDER BY lower(term), term LIMIT '+ maxResults +' OFFSET ' + offset;
              queryParams = [term,termSearch1,termSearch2];
            }
            
            tx.executeSql(query, queryParams, function(tx, results) {
              var result = [];
              var len=results.rows.length;
               for(var i=0; i<len; i++) {
                var row = results.rows.item(i);
                result.push([ row.term ]);
              }
              try {
//                db.close();
              } catch (ex) {}
              callback(result);
            }, function(tx, error){
              alert('SQL error while reading termlist for input "'+term+'" from DB:'+error.message);
              try {
//                db.close();
              } catch (ex) {}
            });
          } catch(e) {
            alert('error while reading termlist for input "'+term+'" from DB:'+e.message);
          }
        });
      }
    };
  
    var DICT={};
    var DICT={
      _needsBackspaceWorkaround:null,
      _touch:false,
      _offset:0,
      dataAccess:{},
      useUnicodeTibetan:true,
      wasTypedInWylie:false,
      DICTLIST:{},
      WORDLIST:[],
      ABBREV:[],
      SEPARATORLIST:[',',';','"','#','/',' ',':','_','`','‘','’','\n','1','2','3','4','5','6','7','8','9','0','０','１','２','３','４','５','６','７','８','９','<','>','(',')','（','）','[',']','{','}','*','—','=','《','》'],
      UNICODE_SEPARATORLIST:[], 
      SYLLABLELIST:{},
      UNICODE_SYLLABLELIST:{},
      dataTable:{},
      activeTerm:"",
      currentInput:"",
      lang:"tib",
      inputLang:"tib",
      lastUniInput:"",
      currentListTerm:"",

      getAbbreviations:function(id) {
        if(!this.ABBREV[id]) {
          var abbrev = ABBREVIATIONS[id];
          var searchPattern = abbrev.match;
          var searchList = [];
          
          if ((typeof searchPattern) === "string") {
            searchPattern = [searchPattern];
          }
    
          for(var i in searchPattern) {
            var search = searchPattern[i];
            
            for (abbr in abbrev.items) {
              var abbrEscaped = abbr.replace(/([\[\]\.\*\+\{\}])/g,'\\$1');
              var termSearch = search.replace("TERM",abbrEscaped);

              if(!searchList[abbr])
                searchList[abbr] = [];
              
              searchList[abbr].push({
                search:new RegExp(termSearch, "mg"),
                explanation:abbrev.items[abbr]
              });
            
              if(termSearch.indexOf(' ')>-1) {
                var abbrCondensed = abbrEscaped.replace(/ /g,'');
                var termSearch2 = search.replace("TERM",abbrCondensed);
                
                var abbrNoSpace = abbr.replace(/ /g,'')
                if(!searchList[abbrNoSpace])
                    searchList[abbrNoSpace] = [];
                
                searchList[abbrNoSpace].push({
                  search:new RegExp(termSearch2, "mg"),
                  explanation:abbrev.items[abbr]
                });
              }
            }
          }
          
          this.ABBREV[id] = searchList;
        }
        return this.ABBREV[id];
      },
      
      processAbbreviations:function(id, text) {
        var abbrevs = DICT.getAbbreviations(id);
        var changed = true;
        while(changed) {
          var t = text;
          for(var abbr in abbrevs) {
            var items = abbrevs[abbr];
          
            for(var itemIds in items) {
              var item = items[itemIds];
              var oldText = "";
              var i = 0;
              while(text != oldText) {
                  oldText = text;
                  text = text.replace(item.search, '$1<span class="tooltip" title="'+abbr+': '+item.explanation+'">$2</span>$3');
                  if(i++>10) {
                    console.log("trouble with replacing "+abbr+" in: "+text);
                    break;
                  }
              }
            }
          }
          if(t===text) {
            changed=false;
          }
        }
        return text;
      },
      
      log:function(x) {
        if(typeof console === "object" && typeof console.log === "function" ) {
          console.log(x);
        }
      },

      isValidSeparator:function(wylie) {
        return jQuery.inArray( wylie, this.SEPARATORLIST) >= 0 || jQuery.inArray( wylie, this.UNICODE_SEPARATORLIST) >= 0;  
      },

      isValidSyllable:function(wylie) {
        if(!wylie)
          return false;

        if(wylie.match(/[aeiou]'a( |$|\/)/)) // syllables ending with an a-chung should end with ' and not with 'a
          return false;

        switch(wylie) {
          case 'm\'i':
            return false;
          case 'gans':
            return false;
          case 'dabs':
            return false;
          case 'dgas':
            return false;
          case 'dams':
            return false;
          case 'badg':
            return false;
          case 'dga':
            return false;
          case 'mna':
            return false;
          case 'bga':
            return false;
          case 'lsa':
            return false;
          case '\'ags':
            return false;
          case 'mngas':
            return false;
          case 'bgas':
            return false;
          case 'gYogs':
            return false;
          case 'ada':
            return false;
          case '\'ba':
            return false;
          case '\'ad ':
            return false;
          case 'dba':
            return false;
          case 'dda':
            return false;
          case '':
            return false;
          case 'ba\'':
            return false;
          case 'banga':
            return false;
          case 'bachu':
            return false;
          case 'bda':
            return false;
          case 'bdzra':
            return false;
          case 'gma':
            return false;
          case 'gna':
            return false;
          case 'gand':
            return false;
          case 'gsa':
            return false;
          case 'kka':
            return false;
          case '\'ma':
            return false;
          case 'mba':
            return false;
          case 'mda':
            return false;
          case 'mga':
            return false;
          case 'mnga':
            return false;
          case '\'nga':
            return false;
          case 'tta':
            return false;
          case 'uta':
            return false;
          case 'ppa':
            return false;
          case 'bngas':
            return false;
          case 'gda':
            return false;
          case 'dna':
            return false;
          case 'dma':
            return false;
          case 'kka':
            return false;
          case '\'an':
            return false;
          case 'padma':
            return true;
          case 'pad+ma':
            return true;
        }
        return /^[gdbm']?[rls]?(?:k|kh|g|ng|c|ch|j|ny|t|th|d|n|p|ph|b|m|ts|tsh|dz|w|zh|z|'|y|r|l|sh|s|h|)[yrlw]?[aeiou](?:'[aeiou]?)?(?:g|ng|d|n|b|m|r|l|s|)?[sd]?$/.test(wylie);  
      },

      /**
       * normalize a piece of Wylie text by fixing common mistakes
       */
      normalizeWylie:function(text) {
        text = text.replace(/v/,'w');
        text = text.replace(/[\u0009\u000A\u000B\u000C\u000D\u0020\u0085\u00A0\u1680\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u2028\u2029\u202F\u205F\u3000\u180E\u200B\u200C\u200D\u2060\uFEFF\u00B7]+/g,' ');
        text = text.replace(/\s*་\s*/g,'་');
        text = text.replace(/^ *[/]/mg,'_');
        text = text.replace(/^ +|[ _]+$/,'');
        if(text != '' && !/.*(?: |\+|\/|་|།)$/.test(text))
          text += ' '; // add a tseg at the end if the text neither ends with a tseg nor a shad
        //text = text.replace(/\s*[-=]\s*/g,' '); //remove special characters
        text = text.replace(/ *(\.\.\.|…) */g,'_…_'); //add spaces before and after "..."
        text = text.replace(/ +([\.\/,;])/g,'$1'); //prevent space before . or shad or , or ;
        text = text.replace(/([]\)}\/\.;,\-=]+) +/g,'$1_'); //space rather than tseg after certain characters
        text = text.replace(/ng\//g,'ng /'); // tseg between nga and shad
        text = text.replace(/[ _]+([-\[\(\{])/g,'_$1'); // add space before certain characters
        text = text.replace(/(\/+|[0-9]\.)[ _]*/g,'$1_'); // add space after shad and other characters
        text = text.replace(/  +/g,' _'); //two spaces -> tseg space
        text = text.replace(/([^a-zA-Z']) +([^\s])/g,'$1_$2'); //space rather than tseg between a non-syllable and a syllable
        text = text.replace(/([a-zA-Z'])([,;])/g,'$1 $2'); //tseg between syllable and various punctuation marks
        text = text.replace(/([^a-zA-Z'])[ _]+$/mg,'$1'); //prevent tsegs after non-word charcters at the end of a line
        text = text.replace(/([aeiou]')([bcdfghjklmnpqrstvwxyz])/ig,'$1a$2'); //enforce a vowel after a-chung
        text = text.replace(/\.( |\/)|\.$/g,'//$1'); //a dot at the end of a syllable cannot be part of the syllable. Convert it to a double-shad

        
        //prevent spaces after certain character combinations (this is a cleanup rule that removes some spaces 
        // that may have been introduced by one of the previous rules but are not desired)
        text = text.replace(/(\/)[ _]([\]\)}])/mg,'$1$2');

        return text;
      },
    
      wylieSyllableToUniSyllable:function(syllable,strictChecks) {
        if(this.SYLLABLELIST[syllable] && (!strictChecks || this.isValidSeparator(syllable) || this.isValidSyllable(syllable)) ) {
          return this.SYLLABLELIST[syllable];
        }
          
        return syllable;
      },

      /**
       * convert a chunk of text from Wylie to Tibetan unicode
       * @param text (string) a piece of text in Wylie transliteration 
       * @param strictChecks (boolean) if true, then the syllable will be 
       *        checked more thoroughly and will only be converted, if it 
       *        matches the usual Tibetan writing rules
       * @return the same piece of text but converted to unicode
       */
      wylieToUni:function(text,strictChecks) {
        result = "";
         //remove dashes that connect syllables inside of wylie chunks but keep "-i" which stands  for a reversed gigu
        text = text.replace(/([^ ])-([^ i])/g,'$1 $2');

        // Tokenize and convert each syllable / token to Unicode
        var separators = [], tokenizer;
        var squigglyBracketsActive = false;
        separators = this.SEPARATORLIST;
        separators = separators.concat(this.UNICODE_SEPARATORLIST);

        if(jQuery.inArray( text, this.SEPARATORLIST)<0)
          text = this.normalizeWylie(text);

        tokenizer = new jQuery.tokenizer( separators, function( syllable, isSeparator ) {
          result += DICT.wylieSyllableToUniSyllable(syllable,strictChecks);
        });
        tokenizer.parse(text);
        result = result.replace(/ +/g,'་');
        return result;
      },
      
      _sktToUniChunk:function(skt) {
        transliterate = {
          'Oṃ':['oM','OM','AUM'],
          'ṛ':['RRi','R^i','R'],
          'ḷ':['LLi','L^i','lR'],
          'ch':['Ch'],
          'ñ':['J','~n','JN'],
          'ṭh':['Th'],
          'ḍh':['Dh'],
          'ṭ':['T'],
          'ḍ':['D'],
          'ṇ':['N'],
          'v':['w'],
          'ṃ':['M','\\.n','\\.m'],
          'ḥ':['H','\\.h'],
          'ṣ':['Sh','shh','S'],
          'ś':['z','sh'],
          'ṅ':['G','~N'],
          'ū':['U','uu'],
          'ī':['I','ii'],
          'ā':['A','aa'],
          'â':['\\^a'],
          'ô':['\\^o'],
          'û':['\\^u'],
          'ê':['\\^e'],
          'î':['\\^i'],
        };
      
        if(skt.toUpperCase() == skt)
          return skt; // don't adjust text that is only comprised of upper case characters
      
        $.each(transliterate,function(uni, transliterations) {
          for(i=0;i<transliterations.length;i++) {
            var transliteration = transliterations[i];
            var replacer = new RegExp(transliteration,"g");
            skt = skt.replace(replacer,uni);
          }
        });
        return skt;
      },
      
      sktToUni:function(skt) {
        var result = "";
        var separators = ['{','}','[',']', ' ', '='];
        var bracketActive;
        var currentTibChunk = "";
        
        tokenizer = new jQuery.tokenizer( separators, function( chunk, isSeparator ) {
          if(isSeparator && ( chunk === '{' || chunk === '[' ) ) {
            bracketActive = true;
          }
          if(isSeparator && ( chunk === '}' || chunk === ']' ) ) {
            bracketActive = false;
          }
            
          if(bracketActive)
            result += chunk;
          else
            result += DICT._sktToUniChunk(chunk);
        });
        tokenizer.parse(skt);
        
        return result;
      },

      uniSyllableToWylieSyllable:function(syllable) {
        syllable = this._normalizeWylieForLookup(syllable);
        if(this.UNICODE_SYLLABLELIST[syllable]) {
          var result = this.UNICODE_SYLLABLELIST[syllable];
          result = result.replace(/([aeiou]')([bcdfghjklmnpqrstvwxyz])/g,"$1a$2");
          return result;
        } else {
          return syllable;
        }
      },

      uniToWylie:function(text) {
        if(this.useUnicodeTibetan) {
          result = "";
          var tokenizer = new jQuery.tokenizer( this.UNICODE_SEPARATORLIST,
            function( syllable, isSeparator ) {
              result += DICT.uniSyllableToWylieSyllable(syllable);
            }
          );
          tokenizer.parse(text);

          return result;
        } else {
          return text;
        }
      },
      
      normalizeInlineEnglish:function(text) {
        text = text.replace(/([,\.]) */g,'$1 ');
        text = text.replace(/ *- */g,' - ');
        return text;
      },
      
      /**
       * convert a chunk of text from Wylie to Tibetan unicode, if unicode is active.
       * Otherwise, simply return the Wylie text.
       * @param text (string) a piece of text in Wylie transliteration 
       * @param strictChecks (boolean) if true, then the syllable will be 
       *        checked more thoroughly and will only be converted, if it 
       *        matches the usual Tibetan writing rules
       * @param ignoreBracketedSections don't change sections in squiggly brackets
       * @return the same piece of text but converted to unicode
       */
      tibetanOutput:function(text,ignoreBracketedSections) {
        if(this.useUnicodeTibetan) {
          if(ignoreBracketedSections) {
            var result = "";
            var bracketActive = false;
            var tokenizer = new jQuery.tokenizer( ['{','}'],
              function( syllable, isSeparator ) {
                if(syllable === '{') {
                  result += ' ';
                  bracketActive = true;
                } else if(syllable === '}') {
                  result += ' ';
                  bracketActive = false;
                } else if(bracketActive) {
                  result += DICT.normalizeInlineEnglish(syllable);
                } else {
                  result += DICT.wylieToUni(syllable,false);
                }
              }
            );
            tokenizer.parse(text);
            return result;
          } else {
            var result = this.wylieToUni(text,false);
            return result;
          }
        } else {
          return text;
        }
      },
      
      setTibetanOutput:function(value) {
        if(value==="true")
          value = true;
        if(value==="false")
          value = false;
        if(value || (value === false))  
          this.useUnicodeTibetan = value;
          
        if(this.useUnicodeTibetan===true||this.useUnicodeTibetan==='output') {
          $('body').addClass('unicodeTib');
          if(DICT.getInputLang()=="tib") {
            $('body').addClass('sidebarTib');
          } else {
            $('body').removeClass('sidebarTib');
          }
        } else {
          $('body').removeClass('unicodeTib');
          $('body').removeClass('sidebarTib');
        }
        
        if(DICT.getInputLang()=="tib") {
          if(this.useUnicodeTibetan===true) {
            $('body').addClass('unicodeTibInput');
          } else {
            $('body').removeClass('unicodeTibInput');
          }
          
          $('body').removeClass('enInput');
        } else {
          $('body').addClass('enInput');
          $('body').removeClass('unicodeTibInput');
        }
      },
      
      getDataAccess:function() {   
        if(window.cordova) {
          DICT._touch = true;
          $('body').addClass('mobile');
          return CordovaDataAccess;
        } else /*if (location.href.indexOf('http')==0)*/ {
          $('body').addClass('desktop');
          return PhpDataAccess;
        }
      },
      
      init:function($) {
        this.getDataAccess().initDB( function() { DICT.doInit($) } );
      },
      
      scrollToTop:function() {
        if($('body').scrollTop() > 0) {
          $('body').animate({ scrollTop: 0 }, 'fast');
        }
        if($('html').scrollTop() > 0) {
          $('html').animate({ scrollTop: 0 }, 'fast');
        }
      },
      
      inputToLowerIfNeeded:function(input) {
        if(SETTINGS.getSettings().lowercase && DICT.getInputLang() === "tib") {
          input = input.toLowerCase();
        }
        return input;
      },
      
      initCreditsInformation:function() {
        var credits = "";
        $.each(SETTINGS.getAllDictionaries(),function(index,currentDictName) {
            var currentDict = DICTLIST[currentDictName];
                
            if(currentDict.listCredits && currentDict.listCredits === "true") {
                var title = "";
                var description = "";
                        
                if(currentDict.about) {
                  title = currentDict.about.replace(/[|].*/, "");
                  description = currentDict.about.replace(/^[^|]*[|]/, "");
                  description = description.replace(/[|]/g,"<br />");
                } else {
                  title = currentDict.label
                }
                credits += "<dt>" + title + "</dt>";
                credits += "<dd>" + description + "</dd>";
            }
        });
        $("#credits").html(credits)
        
      },

      needsBackspaceWorkaround:function() {
        // old versions of Android cannot delete Tibetan script when pressing backspace
        // in that case we need workarounds
        if(this._needsBackspaceWorkaround === null) {
          this._needsBackspaceWorkaround = /Android [1234][^0-9]/.test(navigator.userAgent)
        }
        return this._needsBackspaceWorkaround;
      },
      
      doInit:function($) {
        try{
          //if(window.cordova) { 
            $('a[href^="http"]').click(function() {
              var handle = cordova.InAppBrowser.open($(this).attr('href'), '_system', 'location=yes');
              handle.close();
              
              return false;
            });
          //}
        
          this.settings = SETTINGS.getSettings();
          if(!window.localStorage)
            $('#settingsBtn').hide();
          
          if(this.settings.layout == 'layout_black') {
          $('body').addClass('dark');
          }
          this.SYLLABLELIST = SYLLABLELIST;
          this.setTibetanOutput(this.settings.unicode);
          this.initCreditsInformation();
          $('#mainScreen').show();
          $('#init').hide();

          var conflicts=[];        
          $.each(this.SYLLABLELIST,function(wylie,uni){
            var existingSyllable = DICT.UNICODE_SYLLABLELIST[uni];
            var oldValid = DICT.isValidSyllable(existingSyllable);
            var newValid = DICT.isValidSyllable(wylie);
            if(DICT.isValidSeparator(wylie)
              ||DICT.isValidSyllable(wylie)
              ||(!existingSyllable && /[a-zA-Z]/.test(wylie))
              ||(oldValid == newValid && existingSyllable.length < wylie.length)                ) {
              DICT.UNICODE_SYLLABLELIST[uni] = wylie;
            }
            if(existingSyllable && oldValid == newValid) {
              conflicts.push(uni + " -> " + existingSyllable + " / " + wylie );
            }
          });
          
          DICT.log(conflicts.length + " conflicting syllables.");
          //DICT.log(conflicts);
          
          $.each(this.SEPARATORLIST,function(idx,value){
            DICT.UNICODE_SEPARATORLIST.push( DICT.wylieToUni(value) );
          });

          this.dataTable = $("#wordList").DataTable({
              processing:false,
              deferRender:false,
              pagingType: "simple",
              searching: false,
              ordering: false,
              dom: 't',
              paging: false,
              columns: columnHeaders = [{"title": "Term"}],
              language: {
                emptyTable: " "
              }
          });

          $('#searchTerm').on('focus click',function(e) {
            if(DICT.useUnicodeTibetan === true && (DICT.getInputLang() === "tib")) {
              if($('#searchTerm').selectRange)
                $('#searchTerm').selectRange($('#searchTerm').val().length);
            }
          });

          $('#searchTerm').on('keypress',function(event){                      
            if(event.keyCode == 13){ //enter
              // if enter is pressed in the input field then convert all syllables to unicode
              DICT.lang = DICT.getInputLang();
              var uniInput = DICT.inputToLowerIfNeeded( $('#searchTerm').val() );
              
              if(DICT.useUnicodeTibetan===true && (DICT.getInputLang() === "tib")) {
                 uniInput = uniInput.replace(/[ _/།]+/g,' ');
                 uniInput = DICT.normalizeWylie(uniInput);
                 var newInput = DICT.uniToWylie(uniInput);
                 var inputText = DICT.tibetanOutput( newInput );
              } else {
                 var newInput = uniInput;
                 var inputText = newInput;
              }
              
              $('#searchTerm').val(inputText).blur();
              DICT.scrollToTop(),
              DICT.search(true,true,0);
            }
          });
          $('#searchTerm').on('keyup mobiletextchange',function(event){
            var uniInput = DICT.inputToLowerIfNeeded( $('#searchTerm').val() ),
                lastUniInput = DICT.lastUniInput,
                newInput = uniInput,
                currentInput = DICT.currentInput;

            if(DICT.getInputLang() === "tib") {
              newInput = DICT.uniToWylie(uniInput).replace(/_/g,' ');
            } else {
              newInput = newInput.replace(/\s+/,' ');
            }

            if ( DICT.getInputLang() === "tib" && /.*['a-zA-Z].*/.test(uniInput) ) {
              // remember the fact that something was typed in Wylie rather than in Tibetan unicode;
              // in this case we will later convert the input back to Wylie when backspace is pressed.
              DICT.wasTypedInWylie = true;
            }
                
            if(event.keyCode == 8 ||(newInput.length < currentInput.length && currentInput.indexOf(newInput)===0)
                                  ||(uniInput.length < lastUniInput.length && lastUniInput.indexOf(uniInput)===0)){ // backspace
              var isAtEndOfSyllable = /(^|[_ /་།])[^a-zA-Z'_ /་།]+$/.test(uniInput);
              if(DICT.wasTypedInWylie && DICT.useUnicodeTibetan===true  &&  (DICT.getInputLang() === "tib") && isAtEndOfSyllable ) {
                // backspace at end of Tibetan syllable after having typed some part of the input in Wylie
                // => convert the last syllable back to Wylie
                var adjusted = DICT.uniToWylie(uniInput).replace(/[_  ]*$/, '');
                var splitPos = adjusted.lastIndexOf(' ');
                if (splitPos>0) {
                    adjusted = DICT.wylieToUni(adjusted.substring(0,splitPos + 1)) + adjusted.substring(splitPos+1);
                }
                
                $('#searchTerm').val(adjusted);
                DICT.search(false,true,0);
                
              } else if(DICT.useUnicodeTibetan===true  &&  (DICT.getInputLang() === "tib") && DICT.needsBackspaceWorkaround() && isAtEndOfSyllable ) {
                // backspace at end of Tibetan syllable after having typed Tibetan directly
                // => on old devices: delete whole syllable
                var adjusted = uniInput.replace(/(^|[_ /་།])[^a-zA-Z'_ /་།]+$/,'$1');
                $('#searchTerm').val(adjusted);
                DICT.search(false,true,0);
              } else {
                // backspace in all other cases
                // => just allow regular logic: allow the last character be deleted. This may be the last Unicode character
                DICT.search(false,true,0);
              }

            } else if(event.keyCode == 32 || (/ $/.test(newInput) && !/ $/.test(currentInput)) || (newInput.length >= 3 && DICT.getInputLang() == 'en') ) { 
               //space at the end of the text or typing in English
              // => convert all syllables to unicode and fill the word list
              if(DICT.useUnicodeTibetan===true && (DICT.getInputLang() === "tib")) {
                newInput = newInput.replace(/[ \/།\s]+/g,' '); // get rid of shad; turn into tseg; prevent double-tsegs
                newInput = DICT.normalizeWylie(newInput);
                var inputText = DICT.tibetanOutput( newInput );
              } else {
                var inputText = newInput;
              }
              $('#searchTerm').val(inputText);
              DICT.search(false,true,0);
            }
            DICT.currentInput = DICT.uniToWylie($('#searchTerm').val());
            DICT.lastUniInput = uniInput;

          });

          // handle navigation events
          // - listen to the "back" button on android
          document.addEventListener("backbutton", function(){
            if(window.location.hash !== 'home') {
              history.back();
            }
          }, false); 
          
          // - listen to changes of the URL
          var hashEventCount = 0;
          $(window).hashchange(function(){
            hashEventCount++;
            
            if(new Date().getTime() - DICT._lastHashEvent < 300) 
              return; //ignore hashchange events that are very quick after a user action
              
            var state = decodeURIComponent(location.hash);
            if(state.indexOf('#')==0) {
              state = state.substring(1);
            } else {
              state = '';
            }

            if(state === 'home') {
              if(hashEventCount > 1) {
                location.reload(); // don't reload right away again when hitting the home page upon startup 
              }
              return;
            }
            
            if(state === ''){
              console.log('leaving App');
              if(navigator.app && navigator.app.exitApp) {
                navigator.app.exitApp();
              }
            }

            DICT.setState(state);
          });

          if(window.location.hash!=='#home') {
            if(location.hash == '' || location.hash == '#')
              location.hash = 'home';
            else
              $(window).hashchange();
          }
        } catch(e) {
          alert('error initializing:'+e.message);
        }
      },
      
      prev:function() {
        if(window.location.hash === 'home') {
          return;
        }
      
        if(DICT._offset > 0) {
          if($('#searchTerm').val() === '' ) {
            if( DICT.useUnicodeTibetan === true ) {
              $('#searchTerm').val(DICT.tibetanOutput(this.currentListTerm));
            } else {
              $('#searchTerm').val(this.currentListTerm);
            }
          }
          var settings = SETTINGS.getSettings();
          DICT.search(false,true,DICT._offset - settings.listSize);
        }
      },

      next:function() {
        if(window.location.hash === 'home') {
          return;
        }

        if($('#searchTerm').val() === '' ) {
            if( DICT.useUnicodeTibetan === true ) {
              $('#searchTerm').val(DICT.tibetanOutput(this.currentListTerm));
            } else {
              $('#searchTerm').val(this.currentListTerm);
            }
        }
        
        var settings = SETTINGS.getSettings();
        DICT.search(false,true,DICT._offset + settings.listSize);
      },
      
      clearInput:function() {
        $('#searchTerm').val('');
        DICT.scrollToTop();
        DICT.search(false,true,0);
        $('#searchTerm').focus();
      },
      
      updateButtonState:function(disablePrev,disableNext) {
        $('#wordList_prev').prop( "disable", disablePrev );
        if(disablePrev)
          $('#wordList_prev').addClass("disabled");
        else 
          $('#wordList_prev').removeClass("disabled");
        
        
        $('#wordList_next').prop( "disable", disableNext );
        if(disableNext)
          $('#wordList_next').addClass("disabled");
        else 
          $('#wordList_next').removeClass("disabled");

      },
      
      highlightListItem:function() {
        $('.selected').removeClass('selected');
        if(DICT.getInputLang() == "en")
          var searchValue = this.activeTerm;
        else
          var searchValue = this.tibetanOutput(this.activeTerm);
          
        $('#wordList td').filter(function(){ return $(this).text() === searchValue || (DICT.getInputLang()=="en" && $(this).text().toLowerCase() === searchValue.toLowerCase() ); }).addClass('selected');
        console.log(searchValue);
      },

      setInputLang:function(targetLang){
        if(targetLang)
            DICT.inputLang = targetLang;
        else if(DICT.getInputLang() == "tib")
            DICT.inputLang = "en";
        else 
            DICT.inputLang = "tib";

        DICT.setTibetanOutput(DICT.useUnicodeTibetan);
        DICT.clearInput();

        if(DICT.getInputLang()==="en") {
            $("#searchTerm").attr("placeholder","Enter an English term...")
            $("#switchBtnEnTib").show();
            $("#switchBtnTibEn").hide();
        } else {
            $("#searchTerm").attr("placeholder","Enter a Tibetan term...")
            $("#switchBtnEnTib").hide();
            $("#switchBtnTibEn").show();
        }
        
      },
      
      switchInputLang:function() {
        DICT.setState(DICT.getCurrentState());
        DICT.setInputLang();
        DICT.setSidebarState(false);
        $('.leftSideBar').css('display','none');
      },
      
      getLang:function(){
        if(DICT.lang)
            return DICT.lang;
        return "tib";
      },

      getInputLang:function(){
        if(DICT.inputLang)
            return DICT.inputLang;
        return "tib";
      },
      
      search:function(loadFirstItem,saveState,offset) {
        var inputText = $('#searchTerm').val();
        if(DICT.getInputLang()==='tib') {
          inputText = this.uniToWylie(inputText);
          inputText = inputText.replace(/^\s+|\s*\/?\s*$/g, '');
          inputText = inputText.replace(/_/g, ' ');
          inputText = inputText.replace(/\s+/g, ' ');
          inputText = inputText.replace(/[ /]+$/g, '');
        }

        
        var settings = SETTINGS.getSettings();

        if(offset<0) {
          offset=0;
        }
        
        
        if(!inputText) {
          DICT.setSidebarState(true);
          return;
        }
        
        var lang = DICT.getInputLang();
          
        if(this.currentListTerm != inputText   //this term wasn't loaded yet
           || this._offset != offset           //jumping to a different offset in the result list
          ) {
          
          this.getDataAccess().readTermList(inputText, lang, offset, settings.listSize + 1, this.settings.activeDictionaries, function(result) {
            var lang = DICT.getInputLang();        
            var tableRows = [];
            if(result.length === 0 && offset > 0 )
              return;
          
            for(var i=0;i<result.length && i<settings.listSize;i++) {
              //result[i][0] = DICT.tibetanOutput(result[i][0]);
              tableRows[i]=[];
              if(lang === "en")
                tableRows[i][0]='<span data-wylie="'+result[i][0]+'">'+result[i][0]+'</span>';
              else
                tableRows[i][0]='<span data-wylie="'+result[i][0]+'">'+DICT.tibetanOutput(result[i][0])+'</span>';
            }
            
            DICT.dataTable.clear();
            $('.leftSideBar').css('display','table-cell');
            if(result.length === 0) {
              DICT.dataTable.rows.add(tableRows);
              DICT.dataTable.draw();
              $('#wordList').off('click');
              $('#wordList,.paginate').hide();
              $('.paginate_info').text('No results found.');
            } else {
              DICT.dataTable.rows.add(tableRows);
              DICT.dataTable.draw();
              $('#wordList,.paginate,#wordListContainer').show();
              $('#wordList').on('click','td', function(){
                $('.selected').removeClass('selected'); 
                $(this).addClass('selected');
                
                var wylie = $(this).children('span').attr('data-wylie');
                DICT.lang=DICT.getInputLang();
                DICT.readTerm(wylie, DICT.getInputLang(), true);
              });
              DICT._offset = offset;
              $('.paginate_info').text('Showing results ' + (offset+1) + ' to ' + (offset+(result.length>settings.listSize?settings.listSize:result.length)) + '.');
            }
            DICT.currentListTerm = inputText;
            if(saveState) {
              if(!loadFirstItem) {
                DICT.setSidebarState(true); 
              }
              DICT.storeNavigationState();
            }
            
            if(loadFirstItem) {
              var termFound = false;
            
              for(var i=0;i<result.length;i++)
                for(var j=0;j<result[i].length;j++)
                  if (result[i][j] === inputText || ( DICT.getInputLang()=="en" && result[i][j].toLowerCase() === inputText.toLowerCase() ) )
                    termFound = true;
              
              if(result.length>0 && termFound) {
                DICT.readTerm(inputText, DICT.getInputLang(), saveState);
                $('#wordList tr:first-child').addClass('selected');               
              } else {
                $('#definitions').html('');
              }
            }
            DICT.highlightListItem();
            DICT.updateButtonState(offset==0,result.length<=settings.listSize);
          });
        } else if(loadFirstItem) {
          //the list in the sidebar was already loaded before but we need to activate the first term
          var $firstRow;
          $('#wordList tr td span').each(function(count, elem) {
            if($(elem).attr('data-wylie') === inputText  || ( DICT.getInputLang()=="en" && $(elem).attr('data-wylie').toLowerCase() === inputText.toLowerCase() )  )
              $firstRow = $(elem)
          });
          
          if($firstRow && $firstRow.length) {
            var firstResult = $firstRow.attr('data-wylie');
            if(firstResult.toLowerCase() === inputText.toLowerCase()) {
              $('#wordList tr:first-child').addClass('selected');
              DICT.readTerm(inputText, lang, saveState);
            }
          } else {
            $('#definitions').html('');
          }
        }
      },
      
      setSidebarState:function(visible) {
          if(visible) {
            $('body').addClass('forceLeftSideVisible');
          } else {
            $('body').removeClass('forceLeftSideVisible');
          }
      },

      getSidebarState:function() {
        return $('body').hasClass('forceLeftSideVisible');
      },
      
      isSmallScreen:function() {
        return $(window).width() <= 600;
      },
      
      getCurrentState:function() {
        var state = {
          activeTerm:this.activeTerm,
          lang:this.getLang(),
          inputLang:this.getInputLang(),
          currentListTerm:this.currentListTerm,
          forceLeftSideVisible:this.getSidebarState(),
          offset:this._offset
        };
        return JSON.stringify(state);
      },

      setState:function(state) {
        if(state && state != "") {
          if(state==='settings') {
            // show settings if requested
            SETTINGS.btnShowSettings();
          } else if($('.settings').is(':visible')) {
            // close settings, if active
            if(state!=='settings') {
              location.reload(true);
              return;
            }
          } else if(state==='home') {
              // do nothing - this is handled by the hashchange event.
              return;
          } else { 
          
            //load a term 
            if(DICT.getCurrentState() === state)
              return;
            
            var stateInfo = JSON.parse(state);

            if(stateInfo.lang)
                DICT.lang = stateInfo.lang;

            if(stateInfo.inputLang)
                DICT.inputLang = stateInfo.inputLang;
            
            DICT.setInputLang( DICT.inputLang );
                        
            if( DICT.useUnicodeTibetan === true && DICT.getInputLang() === "tib") {
              $('#searchTerm').val(this.tibetanOutput(stateInfo.currentListTerm));
            } else {
              $('#searchTerm').val(stateInfo.currentListTerm);
            }
            
            $('.selected').removeClass('selected');

            if(stateInfo.offset)
              this.search(false,false,stateInfo.offset);
            else
              this.search(false,false,0);

            
            if((!stateInfo.forceLeftSideVisible) || (!this.isSmallScreen()))
              this.readTerm(stateInfo.activeTerm,DICT.getLang(), false);
              
            this.setSidebarState(stateInfo.forceLeftSideVisible);
            this.currentInput = stateInfo.currentListTerm;
          }
        }
      },

      readTerm:function(term, saveState){
        this.scrollToTop();
        term = this._normalizeWylieForLookup(term);
        term = unescape(term).replace(/^\s+|\s+$/g, '');
        if(this.activeTerm != term) {
          this.getDataAccess().readTerm(term, DICT.getLang(), this.settings.activeDictionaries, saveState);
          this.activeTerm = term;
        } else {
          if(this.isSmallScreen() && this.getSidebarState()) {
            //hide sidebar if necessary
            this.setSidebarState(false);
          }
        }
        
      },
      
      storeNavigationState:function() {
        this._lastHashEvent = new Date().getTime();
        window.location.hash = escape(DICT.getCurrentState());
      },
      
      _escapeRegExp:function(str) {
        return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
      },

      _normalizeWylieForLookup:function(wylie) {
        // remove unwanted characters - especially whitespace stuff
        if(wylie===' ')
          return wylie;
        wylie = wylie.replace('/',' ');
        wylie = wylie.replace(/[()]/g,' ');
        wylie = wylie.replace(/\s\s+/g,' ');
        wylie = wylie.replace(/^\s+|\s+$/g,'');
        return wylie;
      },

      convertInlineTibetanSections:function(definition, definitionNr) {
        var chunks = definition.match(/[{][^{}]+[}]/g);

        if(!chunks)
          return definition;

        var sections={};
        var sectionCount=0;

        for(var i=0;i<chunks.length;i++) {
          var chunk = chunks[i];
          chunk.replace(/\\/g,"\\\\");
          var chunkContents = this.normalizeWylie(chunk).replace(/[{}]/g,'').replace(/^\s+|\s+$/g,'');
          var out = this.tibetanOutput(chunkContents,false); //,true
          var lookup = this._normalizeWylieForLookup(chunkContents);

          if((!this.useUnicodeTibetan) ||(/.*[a-z].*/.test(chunkContents) && !/^.*[a-zA-Z0-9].*$/.test(out))) {
            var sectionId = 'tibSection' + definitionNr + '_' + i;
            var title = chunk.replace(/\n/g,' ');

            out = out.replace(/\n/g,'<br />');
            out = out.replace(/\\n/g,'<br />');
            out = out.replace(/([()]|&gt;|&lt;)/g,'<span class="paren">$1</span>');

            definition = definition.replace(chunk,'<span id="'+sectionId+'" class="tib inlineTib" title="'+DICT.htmlEscapeTitle(title)+'">'+out+'</span>');

            sections[sectionId] = {
              wylie:lookup
            };
            sectionCount++;

          }
        }
        if(sectionCount>0) {
          DICT.getDataAccess().checkTibetanSectionsForLinks(sections);
        }

        return definition;
      },

      /**
       * make all Tibetan sections into "links" where we can do so...
       */
      activateInlineTibetanSections:function(availableSections) {
        $.each(availableSections,function(sectionId, sectionInfo){
          if(DICT.activeTerm != sectionInfo.wylie) {
            $('#'+sectionId)
              .addClass('link')
              .attr('data-wylie',sectionInfo.wylie)
              .click( function() { 
                DICT.lang="tib";
                DICT.readTerm( $(this).attr('data-wylie'), "tib", true );
              });
          }
        });
      },

      breakDefinitionIntoSections:function(definition) {
        if(definition.match(/([^0-9]|^)1[\.)]/)&&definition.match(/([^0-9]|^)2[\.)]/)) {
          // break before numbers like "1." or "1)"
          definition = definition.replace(/([^-0-9(])([(]?[1-9][0-9]?[\.)] ?)([^0-9])/mg,'$1\n$2 $3');
          definition = definition.replace(/^([(]?[1-9][0-9]?[\.)] ?)([^0-9])/mg,'$1 $2');
        }
        return definition;
      },

      htmlEscapeDefinition:function(definition) {
        definition = this.htmlEscape(definition);
        
        definition = definition.replace(/\\+n/g,'\n'); 
        definition = definition.replace(/\\/g,''); 
        definition = definition.replace(/([a-zA-Z0-9\.]){/g,'$1 {');
        definition = definition.replace(/}([a-zA-Z0-9])/g,'} $1');
        definition = definition.replace(/:/g,': ');
        definition = definition.replace(/ - /g,' &ndash; ');

        return '<p>' + definition + '</p>';
      },

      htmlEscapeTitle:function(title) {
        title = this.htmlEscape(title);
        title = title.replace(/{/g,'&#123;');
        title = title.replace(/}/g,'&#125;');
        title = title.replace(/\n/g,' ');
        title = title.replace(/<[^>]*>/g,' ');
        title = title.replace(/  +/g,' ');        

        return title;
      },
      
      htmlEscape:function(text) {
        text = text.replace(/&/g,'&amp;');
        text = text.replace(/</g,'&lt;');
        text = text.replace(/>/g,'&gt;');
        text = text.replace(/"/g,'&quot;');
                       
        return text;
      },
      
      loadTerm:function(term,dictEntries,saveState) {
        $('#definitions *').remove();
        if(DICT.getLang()==="en")
          var termUni = term;
        else
          var termUni = this.tibetanOutput( term );
        var definitionTab = '<h1 class="definitionHead definitionHead'+DICT.getLang()+'" title="'+this.htmlEscapeTitle(term)+'">'+termUni+'</h1><table id="definitionList">';
        var definitionNr = 0;
        var dictList = this.settings.activeDictionaries;
        $.each(dictList,function(idx,currentDictName) {        
          $.each(dictEntries,function(dictName,definition) {
            if(dictName == currentDictName) {
              var currentDict = DICTLIST[dictName];
              if(!currentDict) {
                console.log("received result for unknown dictionary '" +dictName+ "'. skipping");
                return;
              } 
              var defStart = "", defEnd = "";
              
              if(currentDict.mergeLines) {
                  definition = definition.replace(/\n/gm,'; ');
                  definition = definition.replace(/\\n/gm,'; ');
              }
              definition = DICT.breakDefinitionIntoSections( definition );
              if(currentDict.containsOnlyTibetan) {
                // FIXME: split at various characters such as before and after: / whitespace * ( ) .   
              
                defStart = '<div class="tib" title="'+DICT.htmlEscapeTitle(definition)+'">';
                definition = DICT.htmlEscapeDefinition( DICT.tibetanOutput( definition, true ) );
                //definition = definition.replace(/(\s*)([^/_,\.\n()*\]\[]{2,}\/?)/g,"$1{$2}"); // split definition at various characters
                //definition = definition.replace(/(}[^{]*?|^)([\]\[0-9\.\/]+)/g,"$1{$2}"); // split definition at various characters
                //definition = DICT.convertInlineTibetanSections( DICT.htmlEscapeDefinition( definition, true ), definitionNr++ );
                defEnd = '</div>';
              } else if(currentDict.containsOnlySkt) {
                defStart = '<div class="skt" title="'+DICT.htmlEscapeTitle(definition)+'">';
                definition = DICT.convertInlineTibetanSections( DICT.sktToUni( DICT.htmlEscapeDefinition( definition ) ), definitionNr++ );
                defEnd = '</div>';
              } else {
                definition =  DICT.convertInlineTibetanSections( DICT.htmlEscapeDefinition(definition), definitionNr++);
              }
                
              definition = definition.replace(/\n/g,'</p>\n<p>');
              definition = definition.replace(/\\n/g,'</p>\n<p>');

              if(currentDict.highlight) {
                definition = definition.replace(new RegExp(currentDict.highlight,'g'),'<b>$1</b>');
              }

              if(currentDict.abbreviations) {             
                definition = DICT.processAbbreviations(currentDict.abbreviations,definition);
              }
              
              definition = defStart + definition + defEnd;

              var tooltipStart = "", tooltipEnd = ""; 
              if(currentDict.about) {
                tooltipStart = '<span class="tooltip" title="'+currentDict.about+'">';
                tooltipEnd   = '</span>';
              }
              definitionTab += '<tr><td class="dictName">'+tooltipStart+currentDict.label/*.replace(/ /g,'<br>')*/+tooltipEnd+'</td><td class="definition">'+definition+'</td></tr>';
            }
          });
        });
        definitionTab += '</table>';
        $(definitionTab).appendTo('#definitions');
        TOOLTIPS.bindTooltipHandlers();
        
        if(saveState) {
          DICT.setSidebarState(false); 
          DICT.storeNavigationState();
        }
        this.highlightListItem();
        this.scrollToTop();
      }
    };
    
    
    SETTINGS={
      isMobileDevice: /iPhone|iPad|iPod|Android|BlackBerry|IEMobile/i.test(navigator.userAgent),
    
      getAllDictionaries:function() {
        var result = [];
        var isLocalhost = window.location && window.location.hostname && (window.location.hostname.indexOf("localhost")==0);
        var publicOnly = GLOBAL_SETTINGS.publicOnly && (!isLocalhost);
        $.each(DICTLIST,function(currentDictName,dictInfo) {
          if((!publicOnly)||(publicOnly && dictInfo.public == "true")) {
            result.push(currentDictName);
          }
        });
        return result;
      },
      
      getDefaultSettings:function() {
          var defaultSettings = {
            layout: 'layout_white',
            unicode: true,
            lowercase: SETTINGS.isMobileDevice, // enable this feature by default on mobile devices but not on other devices.
            activeDictionaries: this.getAllDictionaries(),
            inactiveDictionaries:[],
            listSize:10
          };
          return defaultSettings;
      },

      getSettings:function() {
        var settingsStr = "";
        if(window.localStorage) {
          settingsStr = localStorage.getItem("settings");
        }
        if(settingsStr) {
          try {
            settings = JSON.parse(settingsStr);
            
            if(!settings.inactiveDictionaries) {
              settings.inactiveDictionaries = [];
            }
            
            if(!settings.listSize) {
              settings.listSize = 10;
            }

            if(settings.listSize > 500) {
              settings.listSize = 500;
            }
            
            if(settings.unicode==='true') {
               settings.unicode=true; 
            }
            if(settings.unicode==='false') {
               settings.unicode===false;
            }
            
            
            // check if any dictionaries have been added since last time when the settings were saved by the user
            var newDictionaries = [];
            $.each(this.getAllDictionaries(),function(index,currentDictName) {
              if($.inArray(currentDictName,settings.activeDictionaries)<0 && $.inArray(currentDictName,settings.inactiveDictionaries)<0 ) {
                newDictionaries.push(currentDictName);
                console.log("added new dict" + currentDictName);
              }
            });
            
            
            settings.activeDictionaries = settings.activeDictionaries.concat( newDictionaries );
            
            return settings;
          } catch(e) {
            // loading of user settings failed -> return defaults
          }
        }
        
        return this.getDefaultSettings();
      },
      
      btnShowSettings:function() {
          DICT.scrollToTop();
          location.hash="settings"

          var settings = SETTINGS.getSettings();
          $('#setting_layout #'+settings.layout).prop('selected',true);
          
          if(settings.unicode===true || settings.unicode==='true') {
            $('#setting_unicode #setting_unicode_true').prop('selected',true);
          }
          else if(settings.unicode===false || settings.unicode==='false') {
            $('#setting_unicode #setting_unicode_false').prop('selected',true);
          }
          else if(settings.unicode==='output') {
            $('#setting_unicode #setting_unicode_output').prop('selected',true);
          }
          
          if(settings.lowercase) {
            $('#setting_lowercase #setting_lowercase_true').prop('selected',true);
          }
          
          if(settings.listSize) {
            $('#setting_list_size').val(settings.listSize);
          }
          
          var activeDicts = [];
          var inactiveDicts = [];
          $.each(settings.activeDictionaries,function(index,currentDictName) {
            var dictInfo = DICTLIST[currentDictName];
            if(dictInfo)
                activeDicts.push(dictInfo);
          });
          
          $.each(this.getAllDictionaries(),function(index,currentDictName) {
            var dictInfo = DICTLIST[currentDictName];
            
            dictInfo.id = currentDictName;
            if($.inArray(currentDictName,settings.activeDictionaries)<0) {
              inactiveDicts.push(dictInfo);
            }
          });
          var dicts = activeDicts.concat(inactiveDicts);
          var dictList = '';

          $.each(dicts,function(idx,dictInfo) {
            var checked = '';
            var currentDictName = dictInfo.id;
            if($.inArray(currentDictName, settings.activeDictionaries)>=0) {
              checked = 'checked';
            } else {
            }
            dictList += '<div class="dictsettings-line" id="dict_wrap_'+currentDictName+'"><span>';
            dictList += '<input type="checkbox" '+checked+' name="dict_'+currentDictName+'" id="dict_'+currentDictName+'"  />';
            dictList += '<label for="dict_'+currentDictName+'">'+dictInfo.label+'</label>';
            dictList += '</span>';
            dictList += '<a href="javascript:SETTINGS.btnMoveDictSettingUp(\'dict_wrap_'+currentDictName+'\')"><img src="code/css/up.png" width="25" height="25"></a>';
            dictList += '<a href="javascript:SETTINGS.btnMoveDictSettingDown(\'dict_wrap_'+currentDictName+'\')"><img src="code/css/down.png" width="25" height="25"></a>';
            dictList += '</div>'
          });
          
          $('#mainScreen').hide();
          $('#select-dict').html(dictList);
          $('#settingsScreen').show();
      },
      
      storeSettings:function(settings) {
        var settingsStr = JSON.stringify(settings);
        localStorage.setItem("settings", settingsStr);      
      },
      
      btnSaveSettings:function() {
        var settings={
          layout:$('#setting_layout option:selected').attr('name'),
          unicode:false,
          lowercase:$('#setting_lowercase option:selected').attr('name') == 'setting_lowercase_true',
          listSize:Number($('#setting_list_size').val()),
          activeDictionaries:[],
          inactiveDictionaries:[]
        };
        $.each($('#select-dict input:checked'), function(idx,item) {
          settings.activeDictionaries.push($(item).attr('id').replace('dict_',''));
        });
        $.each($('#select-dict input:not(:checked)'), function(idx,item) {
          settings.inactiveDictionaries.push($(item).attr('id').replace('dict_',''));
        });
        
        if($('#setting_unicode option:selected').attr('name') == 'setting_unicode_true')
          settings.unicode = 'true';
        else if($('#setting_unicode option:selected').attr('name') == 'setting_unicode_output')
          settings.unicode = 'output';
        else
          settings.unicode = 'false';

        this.storeSettings(settings);
        history.back();
      },
      
      btnCancelSettings:function() {
        history.back();
      },

      btnResetSettings:function() {
        this.storeSettings(this.getDefaultSettings());
        history.back();
      },
      
      btnMoveDictSettingDown:function(id) {
        var $el = $('#'+id);
        $el.before($($el.next()));
      },
      
      btnMoveDictSettingUp:function(id) {
        var $el = $('#'+id);
        $el.after($($el.prev()));
      }
          
    }

    //if (navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry|IEMobile)/)) {
    if(window.cordova) {
      //phonegap-based initialization
      document.addEventListener("deviceready", function(){
          jQuery(function($){
          $.fn.selectRange = function(start, end) {
            if(end === undefined) {
                end = start;
            }
            return this.each(function() {
                if('selectionStart' in this) {
                    this.selectionStart = start;
                    this.selectionEnd = end;
                } else if(this.setSelectionRange) {
                    this.setSelectionRange(start, end);
                } else if(this.createTextRange) {
                    var range = this.createTextRange();
                    range.collapse(true);
                    range.moveEnd('character', end);
                    range.moveStart('character', start);
                    range.select();
                }
            });
          };
        
          DICT.init($);
        });
      }, false);
    } else {
      //regular initialization
      jQuery(function($){
        DICT.init($);
      });
    }
  </script>
  <link rel="stylesheet" href="code/css/main.css">
</head>
<body>
  <div id="init">
    <div id="initMsg">
      <p>Loading... Please wait...</p>
      <p>When you start this program for the first time, this can take several minutes depending on your device. This will only happen when you run the program for the first time. Please be patient...</p>
      <!-- <img class="loader" src="code/css/loader.gif"> -->
    </div>
  </div>  
  <div id="mainScreen" style="display:none">
    <div class="textInput">
      <div class="textInputWrap"><input type="text" id="searchTerm" placeholder="Enter a Tibetan term..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></div>
      <a id="clearBtn"       href="javascript:DICT.clearInput();"><img title="Clear input" src="code/css/clear.png" width="32" height="43"></a>
      <a id="switchBtnTibEn" href="javascript:DICT.switchInputLang();" class="switchBtn"><img title="Switch input language" src="code/css/tib-en.png" width="23" height="43"></a>
      <a id="switchBtnEnTib" href="javascript:DICT.switchInputLang();" style="display:none" class="switchBtn"><img title="Switch input language" src="code/css/en-tib.png" width="23" height="43"></a>
      <a id="settingsBtn"    href="javascript:SETTINGS.btnShowSettings();"><img title="Settings" src="code/css/settings.png" width="32" height="43"></a>
    </div>
    <div class="page">
      <div class="contentArea">
        <div class="leftSideBar" style="display:none">
          <div class="sideBarInnerWrap">
            <div id="wordListContainer" style="display:none">
              <table id="wordList" class="dataTable"></table>
              <div class="paginate_info"></div>
              <div class="paginate">
                <a id="wordList_prev" href="javascript:DICT.prev();">Previous</a>
                <a id="wordList_next" href="javascript:DICT.next();">Next</a>
              </div>
            </div>
          </div>
        </div>
        <div class="mainWrap">
          <div id="definitions">
            <h1>Welcome to the Tibetan-English dictionary!</h1>
            <p><strong><em>Please enter a Tibetan term above.</em></strong> You can either type in Wylie transliteration or you can use a Tibetan keyboard layout.</p>
            <p>After typing a term, klick on one of the suggestions in the list or press the Enter key to open the result directly.</p>
            <p>If you are unfamiliar with Wylie transliteration, see <a href="http://resources.christian-steinert.de/download/WylieTransliteration.pdf">this short summary</a>.</p>
            <p>&nbsp;</p>
            <p><a href="#" onclick="$(this).hide();$('#aboutInfo').show();return false;">Click here to read more about this app...</a></p>
            <div id="aboutInfo" style="display:none">
                
                <h1>About this application</h1>
                <p>This application is available both as <a href="http://dictionary.christian-steinert.de">online application</a> and as <a href="http://www.christian-steinert.de/home/buddhist-apps/tibetan-dictionary">android app</a>. It was written as a hybrid html5 application with most of the application logic being implemented in Javascript. The online version uses a simple PHP backend for data retrieval whereas the android version uses phonegap. In both cases an sqlite database is used as dictionary store. <a href="https://github.com/christiansteinert/tibetan-dictionary">The source code of this app is available on github.</a></p><p>You can find my rather minimalistic homepage containing information about other dictionary sources and various other bits and pieces about Tibetan Buddhism and computing at: <a href="http://www.christian-steinert.de">www.christian-steinert.de</a></p>
                
                <h1>Contained Dictionaries</h1>
                <p>This application contains dictionaries and glossary by the following authors. Thanks go to the authors and compilers of these works without whose work this application would not be possible. Please note that the copyright of the included material remains with the original authors:</p>
                <dl id="credits"></dl>
                
                <h1>Contained Fonts</h1>
                <p>This application contains the DDC Uchen Web Font by <a href="https://sites.google.com/site/chrisfynn2/">Christopher J. Fynn</a> which is available under the <a href="http://scripts.sil.org/cms/scripts/page.php?site_id=nrsi&id=OFL_web">OFL Font Licence</a></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="settingsScreen" style="display:none">
    <form class="settings">
      <div>
        <strong><label for="setting_unicode">Show Tibetan Text:</label></strong>
        <span>
          <select name="setting_unicode" id="setting_unicode" size="1">
            <option name="setting_unicode_true" id="setting_unicode_true">Show Tibetan text in Tibetan script</option>
            <option name="setting_unicode_output" id="setting_unicode_output">Show Tibetan text in Tibetan script but leave input in Wylie transliteration</option>
            <option name="setting_unicode_false" id="setting_unicode_false">Show all Tibetan text in Wylie transliteration</option>
            
          </select>
        </span>
      </div>
      
      <div>
        <strong><label for="setting_lowercase">Convert all text to lower case?</label></strong>
        <span>
          <select name="setting_lowercase" id="setting_lowercase" size="1">
            <option name="setting_lowercase_false" id="setting_lowercase_false">Allow typing of upper case Wylie</option>
            <option name="setting_lowercase_true" id="setting_lowercase_true">Convert all Wylie input to lower case</option>
          </select>
          <br />
          <div class="settingsinfo">(Mobile devices often have auto-capitalization features that interfere with Wylie input - in such cases it can be convenient if the app converts all Wylie input to lower case before actually working with the text that was typed. However, only if upper case input is allowed then searching for Sanskrit-based Tibetan terms with special Tibetan letters (e.g. "paNDita") is possible - so if you intend to search for such terms then you need to allow upper case typing.)
          </div>
        </span>
      </div>

      <div>
        <strong><label for="setting_list_size">Number of results:</label></strong>
        <span>
          <select name="setting_list_size" id="setting_list_size" size="1">
            <option name="setting_list_size_10" id="setting_list_size_10" value="10">10</option>
            <option name="setting_list_size_25" id="setting_list_size_25" value="25">25</option>
            <option name="setting_list_size_50" id="setting_list_size_50" value="50">50</option>
            <option name="setting_list_size_100" id="setting_list_size_100" value="100">100</option>
            <option name="setting_list_size_250" id="setting_list_size_250" value="250">250</option>
          </select>
          <br />
          <div class="settingsinfo">(While starting to type a word after each syllable a list of results starting with that syllable is shown. With this setting you can choose how many items are listed at most before you have to use buttons to jump to the next page of results)
          </div>
        </span>
      </div>
      
      <div>
        <span class="label"><strong>Active Dictio&shy;naries</strong> (select the dictionaries that you want to use  and change their order if you like):</span>
        <p id="select-dict"></p>
      </div>
      
      <div>
        <strong><label for="setting_layout">Color Scheme:</label></strong>
        <span>
          <select name="setting_layout" id="setting_layout" size="1">
            <option name="layout_white" id="layout_white">black text, white background</option>      
            <option name="layout_black" id="layout_black">white text, black background</option>      
          </select>
        </span>
      </div>
      
      <div class="buttons">
        <span></span>
        <span>
          <input type="button" value="Cancel" onclick="SETTINGS.btnCancelSettings();return false;" />
          <input type="button" value="Reset to Default" title="Reset these settings to the default values." onclick="SETTINGS.btnResetSettings();;return false;" />
          <input type="button" value="Save" onclick="SETTINGS.btnSaveSettings();return false;" />
        </span>
      </div>
    </form>
    
  </div>
</body>
</html>
